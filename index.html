<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Sobreaviso RX - App</title>
    
    <!-- PWA CONFIG -->
    <meta name="theme-color" content="#0056b3">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link rel="manifest" href="manifest.json">
    
    <style>
        /* ESTILOS GERAIS */
        :root {
            --primary: #0056b3;
            --secondary: #6c757d;
            --success: #28a745;
            --danger: #dc3545;
            --warning: #ffc107;
            --light: #f8f9fa;
            --dark: #343a40;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f0f2f5;
            color: #333;
            padding: 10px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: white;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            padding: 15px;
        }
        
        /* CABE√áALHO */
        .app-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--primary);
        }
        
        .app-header h1 {
            color: var(--primary);
            font-size: 1.5rem;
        }
        
        /* MENU */
        .main-menu {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            overflow-x: auto;
            padding: 10px 0;
        }
        
        .menu-btn {
            padding: 12px 15px;
            background: var(--light);
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: var(--dark);
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .menu-btn.active {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }
        
        /* ABAS */
        .tab-content {
            display: none;
            animation: fadeIn 0.3s;
        }
        
        .tab-content.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        /* FORMUL√ÅRIOS */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 10px;
            margin-bottom: 20px;
            background: var(--light);
            padding: 15px;
            border-radius: 8px;
        }
        
        .form-group {
            display: flex;
            flex-direction: column;
        }
        
        label {
            margin-bottom: 5px;
            font-weight: 600;
            font-size: 0.85em;
            color: #555;
        }
        
        input, select {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        input:focus, select:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(0,86,179,0.2);
        }
        
        /* BOT√ïES */
        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 6px;
            font-weight: bold;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        
        .btn-success {
            background: var(--success);
            color: white;
        }
        
        .btn-danger {
            background: var(--danger);
            color: white;
        }
        
        .btn-warning {
            background: var(--warning);
            color: #333;
        }
        
        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        /* TABELAS */
        .table-container {
            overflow-x: auto;
            margin-top: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85em;
        }
        
        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: left;
        }
        
        th {
            background: var(--primary);
            color: white;
            font-weight: 600;
        }
        
        tr:nth-child(even) {
            background: #f9f9f9;
        }
        
        /* ESTAT√çSTICAS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .stat-card {
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            text-align: center;
            border: 1px solid #eee;
        }
        
        .stat-card h3 {
            color: var(--primary);
            margin-bottom: 10px;
            font-size: 0.9em;
        }
        
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }
        
        /* RESPONSIVO */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .app-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-group {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .main-menu {
                flex-wrap: nowrap;
                overflow-x: auto;
            }
        }
        
        /* MENSAGENS */
        .message {
            padding: 15px;
            border-radius: 8px;
            margin: 10px 0;
            display: none;
        }
        
        .message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- CABE√áALHO -->
        <div class="app-header">
            <h1>üì± Sobreaviso RX</h1>
            <div style="font-size: 0.9em; color: #666;">
                App instalado ‚úÖ
            </div>
        </div>
        
        <!-- MENU PRINCIPAL -->
        <div class="main-menu">
            <button class="menu-btn active" onclick="abrirAba('dashboard')">
                üìä Dashboard
            </button>
            <button class="menu-btn" onclick="abrirAba('exames')">
                üìã Exames
            </button>
            <button class="menu-btn" onclick="abrirAba('corridas')">
                üöó Corridas
            </button>
            <button class="menu-btn" onclick="abrirAba('relatorios')">
                üìà Relat√≥rios
            </button>
            <button class="menu-btn" onclick="abrirAba('backup')">
                üíæ Backup
            </button>
        </div>
        
        <!-- MENSAGENS -->
        <div id="message" class="message"></div>
        
        <!-- DASHBOARD -->
        <div id="dashboard" class="tab-content active">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üìä Dashboard</h2>
            
            <!-- ESTAT√çSTICAS -->
            <div class="stats-grid">
                <div class="stat-card">
                    <h3>Total Exames</h3>
                    <div class="stat-value" id="totalExames">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Corridas</h3>
                    <div class="stat-value" id="totalCorridas">0</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total Horas</h3>
                    <div class="stat-value" id="totalHoras">00:00</div>
                </div>
                
                <div class="stat-card">
                    <h3>Total KM</h3>
                    <div class="stat-value" id="totalKm">0.0</div>
                </div>
            </div>
            
            <!-- A√á√ïES R√ÅPIDAS -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #555;">‚ö° A√ß√µes R√°pidas</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="abrirAba('exames')">
                        ‚ûï Novo Exame
                    </button>
                    <button class="btn btn-success" onclick="abrirAba('corridas')">
                        ‚ûï Nova Corrida
                    </button>
                    <button class="btn btn-warning" onclick="gerarRelatorio()">
                        üìÑ Gerar Relat√≥rio
                    </button>
                    <button class="btn btn-danger" onclick="limparTudo()">
                        üóëÔ∏è Limpar Tudo
                    </button>
                </div>
            </div>
            
            <!-- √öLTIMOS REGISTROS -->
            <div style="margin-top: 30px;">
                <h3 style="margin-bottom: 15px; color: #555;">üìã √öltimos Exames</h3>
                <div class="table-container">
                    <table id="ultimosExames">
                        <thead>
                            <tr>
                                <th>Data</th>
                                <th>Setor</th>
                                <th>Exame</th>
                                <th>Paciente</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- EXAMES -->
        <div id="exames" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üìã Gerenciar Exames</h2>
            
            <!-- FORMUL√ÅRIO -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="dataExame">Data *</label>
                    <input type="date" id="dataExame" value="">
                </div>
                
                <div class="form-group">
                    <label for="horaEntrada">Hora Entrada</label>
                    <input type="time" id="horaEntrada">
                </div>
                
                <div class="form-group">
                    <label for="horaSaida">Hora Sa√≠da</label>
                    <input type="time" id="horaSaida">
                </div>
                
                <div class="form-group">
                    <label for="setorExame">Setor *</label>
                    <select id="setorExame">
                        <option value="">Selecione...</option>
                        <option value="SUE">SUE</option>
                        <option value="UTI 1">UTI 1</option>
                        <option value="UTI 2">UTI 2</option>
                        <option value="UTI 3">UTI 3</option>
                        <option value="UTI 4">UTI 4</option>
                        <option value="RIO NEGRO">RIO NEGRO</option>
                        <option value="OUTRO">OUTRO</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="tipoExame">Exame *</label>
                    <input type="text" id="tipoExame" placeholder="Ex: TC CRANIO">
                </div>
                
                <div class="form-group">
                    <label for="paciente">Paciente *</label>
                    <input type="text" id="paciente" placeholder="Nome do paciente">
                </div>
            </div>
            
            <!-- BOT√ïES -->
            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarExame()">
                    üíæ Salvar Exame
                </button>
                <button class="btn btn-warning" onclick="limparFormExame()">
                    üßπ Limpar
                </button>
                <button class="btn btn-danger" onclick="limparTodosExames()">
                    üóëÔ∏è Limpar Todos
                </button>
            </div>
            
            <!-- LISTA DE EXAMES -->
            <div class="table-container">
                <table id="tabelaExames">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Entrada</th>
                            <th>Sa√≠da</th>
                            <th>Tempo</th>
                            <th>Setor</th>
                            <th>Exame</th>
                            <th>Paciente</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- CORRIDAS -->
        <div id="corridas" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üöó Gerenciar Corridas</h2>
            
            <!-- FORMUL√ÅRIO -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="dataCorrida">Data *</label>
                    <input type="date" id="dataCorrida" value="">
                </div>
                
                <div class="form-group">
                    <label for="kmCorrida">KM Rodados *</label>
                    <input type="number" step="0.1" id="kmCorrida" placeholder="Ex: 2.5">
                </div>
                
                <div class="form-group">
                    <label for="obsCorrida">Observa√ß√£o</label>
                    <input type="text" id="obsCorrida" placeholder="Ex: Para buscar material">
                </div>
            </div>
            
            <!-- BOT√ïES -->
            <div class="btn-group">
                <button class="btn btn-success" onclick="salvarCorrida()">
                    üíæ Salvar Corrida
                </button>
                <button class="btn btn-warning" onclick="limparFormCorrida()">
                    üßπ Limpar
                </button>
                <button class="btn btn-danger" onclick="limparTodasCorridas()">
                    üóëÔ∏è Limpar Todas
                </button>
            </div>
            
            <!-- RESUMO -->
            <div style="background: #e9ecef; padding: 15px; border-radius: 8px; margin: 20px 0;">
                <h3 style="color: #333; margin-bottom: 10px;">üìä Resumo de Corridas</h3>
                <div style="display: flex; gap: 20px;">
                    <div>
                        <strong>Total Registros:</strong>
                        <span id="totalRegCorridas" style="font-size: 1.2em; margin-left: 10px;">0</span>
                    </div>
                    <div>
                        <strong>Total KM:</strong>
                        <span id="totalKmCorridas" style="font-size: 1.2em; margin-left: 10px;">0.0</span>
                    </div>
                </div>
            </div>
            
            <!-- LISTA DE CORRIDAS -->
            <div class="table-container">
                <table id="tabelaCorridas">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>KM</th>
                            <th>Observa√ß√£o</th>
                            <th>A√ß√µes</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        
        <!-- RELAT√ìRIOS -->
        <div id="relatorios" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üìà Gerar Relat√≥rios</h2>
            
            <!-- FILTROS -->
            <div class="form-grid">
                <div class="form-group">
                    <label for="dataInicio">Data In√≠cio</label>
                    <input type="date" id="dataInicio">
                </div>
                
                <div class="form-group">
                    <label for="dataFim">Data Fim</label>
                    <input type="date" id="dataFim">
                </div>
                
                <div class="form-group">
                    <label for="periodoTexto">Per√≠odo Texto</label>
                    <input type="text" id="periodoTexto" placeholder="Ex: 22/11 a 23/11">
                </div>
            </div>
            
            <!-- BOT√ïES -->
            <div class="btn-group">
                <button class="btn btn-primary" onclick="gerarRelatorio()">
                    üìä Gerar Relat√≥rio
                </button>
                <button class="btn btn-success" onclick="gerarPDF()">
                    üìÑ Exportar PDF
                </button>
                <button class="btn btn-warning" onclick="imprimirRelatorio()">
                    üñ®Ô∏è Imprimir
                </button>
            </div>
            
            <!-- VISUALIZA√á√ÉO DO RELAT√ìRIO -->
            <div id="relatorioPreview" style="margin-top: 30px;">
                <!-- O relat√≥rio ser√° gerado aqui -->
            </div>
        </div>
        
        <!-- BACKUP -->
        <div id="backup" class="tab-content">
            <h2 style="margin-bottom: 20px; color: var(--primary);">üíæ Backup & Restaura√ß√£o</h2>
            
            <!-- OP√á√ïES -->
            <div style="background: #f8f9fa; padding: 20px; border-radius: 8px;">
                <h3 style="color: #333; margin-bottom: 15px;">üì§ Exportar Dados</h3>
                <div class="btn-group">
                    <button class="btn btn-primary" onclick="exportarDados()">
                        üíæ Fazer Backup
                    </button>
                    <button class="btn btn-success" onclick="importarDados()">
                        üìÇ Restaurar Backup
                    </button>
                </div>
                
                <h3 style="color: #333; margin-top: 30px; margin-bottom: 15px;">‚öôÔ∏è Configura√ß√µes</h3>
                <div class="form-grid">
                    <div class="form-group">
                        <label for="autoBackup">Backup Autom√°tico</label>
                        <select id="autoBackup">
                            <option value="0">Desativado</option>
                            <option value="300000">5 minutos</option>
                            <option value="1800000">30 minutos</option>
                            <option value="3600000">1 hora</option>
                        </select>
                    </div>
                </div>
                
                <div style="margin-top: 20px; padding: 15px; background: white; border-radius: 6px;">
                    <h4>üìä Estat√≠sticas do Sistema</h4>
                    <p><strong>Total de Dados Salvos:</strong> <span id="totalDados">0</span></p>
                    <p><strong>√öltimo Backup:</strong> <span id="ultimoBackup">Nunca</span></p>
                    <p><strong>Espa√ßo Usado:</strong> <span id="espacoUsado">0 KB</span></p>
                </div>
            </div>
        </div>
    </div>

    <!-- √ÅREA DE IMPRESS√ÉO (OCULTA) -->
    <div id="areaImpressao" style="display: none;">
        <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #000; padding-bottom: 20px;">
            <h2>RELAT√ìRIO SOBREAVISO RX</h2>
            <h3 id="printPeriodo">PER√çODO: </h3>
            <p id="printData">Gerado em: </p>
        </div>
        
        <div id="printContent">
            <!-- Conte√∫do ser√° inserido aqui -->
        </div>
        
        <div style="margin-top: 50px; text-align: center; border-top: 1px solid #000; padding-top: 20px;">
            <p>_________________________________________</p>
            <p>Assinatura do Respons√°vel</p>
        </div>
    </div>

    <script>
        // ==================== VARI√ÅVEIS GLOBAIS ====================
        let exames = [];
        let corridas = [];
        let exameEditando = null;
        let corridaEditando = null;

        // ==================== INICIALIZA√á√ÉO ====================
        document.addEventListener('DOMContentLoaded', function() {
            console.log('App Sobreaviso RX iniciado!');
            
            // Configurar data atual nos formul√°rios
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataExame').value = hoje;
            document.getElementById('dataCorrida').value = hoje;
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
            
            // Carregar dados salvos
            carregarDados();
            
            // Atualizar dashboard
            atualizarDashboard();
            
            // Configurar PWA
            configurarPWA();
            
            // Mostrar mensagem de boas-vindas
            mostrarMensagem('‚úÖ App carregado com sucesso!', 'success');
        });

        // ==================== FUN√á√ïES DO MENU ====================
        function abrirAba(abaId) {
            // Remover classe active de todos os bot√µes
            document.querySelectorAll('.menu-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Adicionar classe active ao bot√£o clicado
            event.currentTarget.classList.add('active');
            
            // Esconder todas as abas
            document.querySelectorAll('.tab-content').forEach(aba => {
                aba.classList.remove('active');
            });
            
            // Mostrar aba selecionada
            document.getElementById(abaId).classList.add('active');
            
            // Se for dashboard, atualizar
            if (abaId === 'dashboard') {
                atualizarDashboard();
            }
        }

        // ==================== EXAMES ====================
        function salvarExame() {
            // Obter valores do formul√°rio
            const data = document.getElementById('dataExame').value;
            const horaEntrada = document.getElementById('horaEntrada').value;
            const horaSaida = document.getElementById('horaSaida').value;
            const setor = document.getElementById('setorExame').value;
            const exame = document.getElementById('tipoExame').value.toUpperCase();
            const paciente = document.getElementById('paciente').value.toUpperCase();
            
            // Validar campos obrigat√≥rios
            if (!data || !setor || !exame || !paciente) {
                mostrarMensagem('‚ùå Preencha todos os campos obrigat√≥rios!', 'error');
                return;
            }
            
            // Calcular tempo
            let tempo = '';
            if (horaEntrada && horaSaida) {
                tempo = calcularTempo(horaEntrada, horaSaida);
            }
            
            // Criar objeto do exame
            const novoExame = {
                id: exameEditando ? exameEditando.id : Date.now(),
                data: data,
                horaEntrada: horaEntrada,
                horaSaida: horaSaida,
                tempo: tempo,
                setor: setor,
                exame: exame,
                paciente: paciente,
                dataCriacao: new Date().toISOString()
            };
            
            // Adicionar ou atualizar
            if (exameEditando) {
                // Atualizar exame existente
                const index = exames.findIndex(e => e.id === exameEditando.id);
                if (index !== -1) {
                    exames[index] = novoExame;
                }
                mostrarMensagem('‚úÖ Exame atualizado com sucesso!', 'success');
                exameEditando = null;
            } else {
                // Adicionar novo exame
                exames.push(novoExame);
                mostrarMensagem('‚úÖ Exame salvo com sucesso!', 'success');
            }
            
            // Salvar no localStorage
            salvarDados();
            
            // Limpar formul√°rio
            limparFormExame();
            
            // Atualizar lista e dashboard
            atualizarListaExames();
            atualizarDashboard();
        }

        function calcularTempo(inicio, fim) {
            const [h1, m1] = inicio.split(':').map(Number);
            const [h2, m2] = fim.split(':').map(Number);
            
            let minutos1 = h1 * 60 + m1;
            let minutos2 = h2 * 60 + m2;
            
            // Se passou da meia-noite
            if (minutos2 < minutos1) {
                minutos2 += 24 * 60;
            }
            
            const diferenca = minutos2 - minutos1;
            const horas = Math.floor(diferenca / 60);
            const minutos = diferenca % 60;
            
            return `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
        }

        function editarExame(id) {
            const exame = exames.find(e => e.id === id);
            if (!exame) return;
            
            // Preencher formul√°rio
            document.getElementById('dataExame').value = exame.data;
            document.getElementById('horaEntrada').value = exame.horaEntrada;
            document.getElementById('horaSaida').value = exame.horaSaida;
            document.getElementById('setorExame').value = exame.setor;
            document.getElementById('tipoExame').value = exame.exame;
            document.getElementById('paciente').value = exame.paciente;
            
            // Configurar modo edi√ß√£o
            exameEditando = exame;
            
            // Ir para aba de exames
            abrirAba('exames');
            
            // Mostrar mensagem
            mostrarMensagem('‚úèÔ∏è Editando exame...', 'success');
            
            // Scroll para o topo
            window.scrollTo(0, 0);
        }

        function excluirExame(id) {
            if (!confirm('Tem certeza que deseja excluir este exame?')) {
                return;
            }
            
            exames = exames.filter(e => e.id !== id);
            salvarDados();
            atualizarListaExames();
            atualizarDashboard();
            mostrarMensagem('üóëÔ∏è Exame exclu√≠do!', 'success');
        }

        function limparFormExame() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataExame').value = hoje;
            document.getElementById('horaEntrada').value = '';
            document.getElementById('horaSaida').value = '';
            document.getElementById('setorExame').value = '';
            document.getElementById('tipoExame').value = '';
            document.getElementById('paciente').value = '';
            exameEditando = null;
        }

        function limparTodosExames() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO!\n\nIsso ir√° excluir TODOS os exames.\nTem certeza?')) {
                return;
            }
            
            exames = [];
            salvarDados();
            atualizarListaExames();
            atualizarDashboard();
            mostrarMensagem('üßπ Todos os exames foram exclu√≠dos!', 'success');
        }

        function atualizarListaExames() {
            const tbody = document.querySelector('#tabelaExames tbody');
            tbody.innerHTML = '';
            
            // Ordenar por data (mais recente primeiro)
            exames.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            exames.forEach(exame => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatarData(exame.data)}</td>
                    <td>${exame.horaEntrada || '-'}</td>
                    <td>${exame.horaSaida || '-'}</td>
                    <td><strong>${exame.tempo || '-'}</strong></td>
                    <td>${exame.setor}</td>
                    <td>${exame.exame}</td>
                    <td>${exame.paciente}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="editarExame(${exame.id})" style="
                            background: #ffc107;
                            color: #333;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 4px;
                            margin-right: 5px;
                            cursor: pointer;
                        ">‚úèÔ∏è</button>
                        <button onclick="excluirExame(${exame.id})" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== CORRIDAS ====================
        function salvarCorrida() {
            const data = document.getElementById('dataCorrida').value;
            const km = parseFloat(document.getElementById('kmCorrida').value);
            const obs = document.getElementById('obsCorrida').value.toUpperCase();
            
            // Validar
            if (!data || isNaN(km) || km <= 0) {
                mostrarMensagem('‚ùå Preencha data e KM corretamente!', 'error');
                return;
            }
            
            const novaCorrida = {
                id: corridaEditando ? corridaEditando.id : Date.now(),
                data: data,
                km: km,
                observacao: obs || '',
                dataCriacao: new Date().toISOString()
            };
            
            if (corridaEditando) {
                const index = corridas.findIndex(c => c.id === corridaEditando.id);
                if (index !== -1) {
                    corridas[index] = novaCorrida;
                }
                mostrarMensagem('‚úÖ Corrida atualizada!', 'success');
                corridaEditando = null;
            } else {
                corridas.push(novaCorrida);
                mostrarMensagem('‚úÖ Corrida salva!', 'success');
            }
            
            salvarDados();
            limparFormCorrida();
            atualizarListaCorridas();
            atualizarDashboard();
        }

        function editarCorrida(id) {
            const corrida = corridas.find(c => c.id === id);
            if (!corrida) return;
            
            document.getElementById('dataCorrida').value = corrida.data;
            document.getElementById('kmCorrida').value = corrida.km;
            document.getElementById('obsCorrida').value = corrida.observacao;
            
            corridaEditando = corrida;
            abrirAba('corridas');
            mostrarMensagem('‚úèÔ∏è Editando corrida...', 'success');
            window.scrollTo(0, 0);
        }

        function excluirCorrida(id) {
            if (!confirm('Excluir esta corrida?')) return;
            
            corridas = corridas.filter(c => c.id !== id);
            salvarDados();
            atualizarListaCorridas();
            atualizarDashboard();
            mostrarMensagem('üóëÔ∏è Corrida exclu√≠da!', 'success');
        }

        function limparFormCorrida() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataCorrida').value = hoje;
            document.getElementById('kmCorrida').value = '';
            document.getElementById('obsCorrida').value = '';
            corridaEditando = null;
        }

        function limparTodasCorridas() {
            if (!confirm('‚ö†Ô∏è Excluir TODAS as corridas?')) return;
            
            corridas = [];
            salvarDados();
            atualizarListaCorridas();
            atualizarDashboard();
            mostrarMensagem('üßπ Todas as corridas exclu√≠das!', 'success');
        }

        function atualizarListaCorridas() {
            const tbody = document.querySelector('#tabelaCorridas tbody');
            tbody.innerHTML = '';
            
            corridas.sort((a, b) => new Date(b.data) - new Date(a.data));
            
            let totalKm = 0;
            
            corridas.forEach(corrida => {
                totalKm += corrida.km;
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatarData(corrida.data)}</td>
                    <td><strong>${corrida.km.toFixed(1)} km</strong></td>
                    <td>${corrida.observacao || '-'}</td>
                    <td style="white-space: nowrap;">
                        <button onclick="editarCorrida(${corrida.id})" style="
                            background: #ffc107;
                            color: #333;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 4px;
                            margin-right: 5px;
                            cursor: pointer;
                        ">‚úèÔ∏è</button>
                        <button onclick="excluirCorrida(${corrida.id})" style="
                            background: #dc3545;
                            color: white;
                            border: none;
                            padding: 5px 10px;
                            border-radius: 4px;
                            cursor: pointer;
                        ">üóëÔ∏è</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // Atualizar resumo
            document.getElementById('totalRegCorridas').textContent = corridas.length;
            document.getElementById('totalKmCorridas').textContent = totalKm.toFixed(1);
        }

        // ==================== DASHBOARD ====================
        function atualizarDashboard() {
            // Total exames
            document.getElementById('totalExames').textContent = exames.length;
            
            // Total corridas
            document.getElementById('totalCorridas').textContent = corridas.length;
            
            // Total horas
            let totalMinutos = 0;
            exames.forEach(exame => {
                if (exame.tempo) {
                    const [h, m] = exame.tempo.split(':').map(Number);
                    totalMinutos += h * 60 + m;
                }
            });
            const horas = Math.floor(totalMinutos / 60);
            const minutos = totalMinutos % 60;
            document.getElementById('totalHoras').textContent = 
                `${horas.toString().padStart(2, '0')}:${minutos.toString().padStart(2, '0')}`;
            
            // Total KM
            const totalKm = corridas.reduce((acc, c) => acc + c.km, 0);
            document.getElementById('totalKm').textContent = totalKm.toFixed(1);
            
            // √öltimos exames
            atualizarUltimosExames();
            
            // Estat√≠sticas do sistema
            atualizarEstatisticasSistema();
        }

        function atualizarUltimosExames() {
            const tbody = document.querySelector('#ultimosExames tbody');
            tbody.innerHTML = '';
            
            const ultimos = exames.slice(0, 5); // √öltimos 5 exames
            
            ultimos.forEach(exame => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${formatarData(exame.data)}</td>
                    <td>${exame.setor}</td>
                    <td>${exame.exame}</td>
                    <td>${exame.paciente}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== RELAT√ìRIOS ====================
        function gerarRelatorio() {
            const dataInicio = document.getElementById('dataInicio').value;
            const dataFim = document.getElementById('dataFim').value;
            const periodoTexto = document.getElementById('periodoTexto').value;
            
            if (!dataInicio || !dataFim) {
                mostrarMensagem('‚ùå Selecione datas de in√≠cio e fim!', 'error');
                return;
            }
            
            // Filtrar exames por per√≠odo
            const examesFiltrados = exames.filter(exame => {
                return exame.data >= dataInicio && exame.data <= dataFim;
            });
            
            // Filtrar corridas por per√≠odo
            const corridasFiltradas = corridas.filter(corrida => {
                return corrida.data >= dataInicio && corrida.data <= dataFim;
            });
            
            // Calcular estat√≠sticas
            let totalHoras = 0;
            examesFiltrados.forEach(exame => {
                if (exame.tempo) {
                    const [h, m] = exame.tempo.split(':').map(Number);
                    totalHoras += h + (m / 60);
                }
            });
            
            const totalKm = corridasFiltradas.reduce((acc, c) => acc + c.km, 0);
            
            // Gerar HTML do relat√≥rio
            const relatorioHTML = `
                <div style="background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1);">
                    <h3 style="color: var(--primary); margin-bottom: 20px;">
                        üìä Relat√≥rio ${periodoTexto ? `- ${periodoTexto}` : ''}
                    </h3>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 30px;">
                        <div style="background: #e3f2fd; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #1976d2;">üìã Exames</h4>
                            <p style="font-size: 32px; font-weight: bold; margin: 10px 0;">${examesFiltrados.length}</p>
                            <p style="color: #666;">registros no per√≠odo</p>
                        </div>
                        
                        <div style="background: #e8f5e9; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #388e3c;">üöó Corridas</h4>
                            <p style="font-size: 32px; font-weight: bold; margin: 10px 0;">${corridasFiltradas.length}</p>
                            <p style="color: #666;">registros no per√≠odo</p>
                        </div>
                        
                        <div style="background: #fff3e0; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #f57c00;">‚è±Ô∏è Total Horas</h4>
                            <p style="font-size: 32px; font-weight: bold; margin: 10px 0;">${totalHoras.toFixed(2)}h</p>
                            <p style="color: #666;">horas trabalhadas</p>
                        </div>
                        
                        <div style="background: #f3e5f5; padding: 15px; border-radius: 8px; text-align: center;">
                            <h4 style="color: #7b1fa2;">üìè Total KM</h4>
                            <p style="font-size: 32px; font-weight: bold; margin: 10px 0;">${totalKm.toFixed(1)}</p>
                            <p style="color: #666;">quil√¥metros</p>
                        </div>
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="color: #555; margin-bottom: 15px;">üìã Detalhamento de Exames</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #0056b3; color: white;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">Data</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Setor</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Exame</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Paciente</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Tempo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${examesFiltrados.map(exame => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${formatarData(exame.data)}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${exame.setor}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${exame.exame}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${exame.paciente}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${exame.tempo || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div style="margin-top: 30px;">
                        <h4 style="color: #555; margin-bottom: 15px;">üöó Detalhamento de Corridas</h4>
                        <div style="overflow-x: auto;">
                            <table style="width: 100%; border-collapse: collapse;">
                                <thead>
                                    <tr style="background: #28a745; color: white;">
                                        <th style="padding: 10px; border: 1px solid #ddd;">Data</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">KM</th>
                                        <th style="padding: 10px; border: 1px solid #ddd;">Observa√ß√£o</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${corridasFiltradas.map(corrida => `
                                        <tr>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${formatarData(corrida.data)}</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${corrida.km.toFixed(1)} km</td>
                                            <td style="padding: 8px; border: 1px solid #ddd;">${corrida.observacao || '-'}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            `;
            
            // Mostrar relat√≥rio
            document.getElementById('relatorioPreview').innerHTML = relatorioHTML;
            mostrarMensagem('‚úÖ Relat√≥rio gerado com sucesso!', 'success');
            
            // Ir para aba de relat√≥rios
            abrirAba('relatorios');
        }

        function gerarPDF() {
            // Implementa√ß√£o simplificada - na pr√°tica use uma biblioteca
            alert('üìÑ Para exportar PDF, use a fun√ß√£o de impress√£o do navegador.');
            imprimirRelatorio();
        }

        function imprimirRelatorio() {
            // Preparar conte√∫do para impress√£o
            const periodoTexto = document.getElementById('periodoTexto').value;
            const hoje = new Date().toLocaleDateString('pt-BR');
            
            // Configurar √°rea de impress√£o
            document.getElementById('printPeriodo').textContent = 
                `PER√çODO: ${periodoTexto || 'Per√≠odo n√£o especificado'}`;
            document.getElementById('printData').textContent = 
                `Gerado em: ${hoje}`;
            
            // Copiar conte√∫do do relat√≥rio
            const relatorioContent = document.getElementById('relatorioPreview').innerHTML;
            document.getElementById('printContent').innerHTML = relatorioContent;
            
            // Imprimir
            const printArea = document.getElementById('areaImpressao');
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Relat√≥rio Sobreaviso RX</title>
                        <style>
                            body { font-family: Arial, sans-serif; padding: 20px; }
                            h2, h3 { text-align: center; }
                            table { width: 100%; border-collapse: collapse; margin: 10px 0; }
                            th, td { border: 1px solid #000; padding: 8px; text-align: left; }
                            th { background-color: #f0f0f0; }
                            .stat { margin: 15px 0; text-align: center; }
                        </style>
                    </head>
                    <body>
                        ${printArea.innerHTML}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.focus();
            printWindow.print();
        }

        // ==================== BACKUP ====================
        function exportarDados() {
            const dados = {
                exames: exames,
                corridas: corridas,
                exportadoEm: new Date().toISOString(),
                versao: '1.0'
            };
            
            const blob = new Blob([JSON.stringify(dados, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `sobreaviso-backup-${new Date().toISOString().slice(0,10)}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            mostrarMensagem('‚úÖ Backup exportado com sucesso!', 'success');
            
            // Atualizar √∫ltimo backup
            localStorage.setItem('ultimoBackup', new Date().toISOString());
            atualizarEstatisticasSistema();
        }

        function importarDados() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const dados = JSON.parse(e.target.result);
                        
                        if (!confirm(`‚ö†Ô∏è Importar ${dados.exames?.length || 0} exames e ${dados.corridas?.length || 0} corridas?\nIsso substituir√° os dados atuais.`)) {
                            return;
                        }
                        
                        if (dados.exames) exames = dados.exames;
                        if (dados.corridas) corridas = dados.corridas;
                        
                        salvarDados();
                        atualizarListaExames();
                        atualizarListaCorridas();
                        atualizarDashboard();
                        
                        mostrarMensagem('‚úÖ Dados importados com sucesso!', 'success');
                    } catch (error) {
                        mostrarMensagem('‚ùå Erro ao importar arquivo!', 'error');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            };
            
            input.click();
        }

        // ==================== UTILIT√ÅRIOS ====================
        function formatarData(dataISO) {
            if (!dataISO) return '';
            const [ano, mes, dia] = dataISO.split('-');
            return `${dia}/${mes}/${ano}`;
        }

        function mostrarMensagem(texto, tipo) {
            const mensagemDiv = document.getElementById('message');
            mensagemDiv.textContent = texto;
            mensagemDiv.className = `message ${tipo}`;
            mensagemDiv.style.display = 'block';
            
            setTimeout(() => {
                mensagemDiv.style.display = 'none';
            }, 3000);
        }

        function salvarDados() {
            localStorage.setItem('sobreavisoExames', JSON.stringify(exames));
            localStorage.setItem('sobreavisoCorridas', JSON.stringify(corridas));
        }

        function carregarDados() {
            const examesSalvos = localStorage.getItem('sobreavisoExames');
            const corridasSalvas = localStorage.getItem('sobreavisoCorridas');
            
            if (examesSalvos) {
                exames = JSON.parse(examesSalvos);
                atualizarListaExames();
            }
            
            if (corridasSalvas) {
                corridas = JSON.parse(corridasSalvas);
                atualizarListaCorridas();
            }
        }

        function limparTudo() {
            if (!confirm('‚ö†Ô∏è ATEN√á√ÉO CR√çTICA!\n\nIsso ir√° limpar TODOS os dados do app:\n- Todos os exames\n- Todas as corridas\n\nTem certeza absoluta?')) {
                return;
            }
            
            exames = [];
            corridas = [];
            salvarDados();
            atualizarListaExames();
            atualizarListaCorridas();
            atualizarDashboard();
            mostrarMensagem('üßπ Todos os dados foram limpos!', 'success');
        }

        function atualizarEstatisticasSistema() {
            // Total de dados
            const totalDados = exames.length + corridas.length;
            document.getElementById('totalDados').textContent = totalDados;
            
            // √öltimo backup
            const ultimoBackup = localStorage.getItem('ultimoBackup');
            if (ultimoBackup) {
                const data = new Date(ultimoBackup);
                document.getElementById('ultimoBackup').textContent = 
                    data.toLocaleDateString('pt-BR') + ' ' + data.toLocaleTimeString('pt-BR').slice(0,5);
            }
            
            // Espa√ßo usado
            const espaco = JSON.stringify(localStorage).length;
            document.getElementById('espacoUsado').textContent = 
                Math.round(espaco / 1024) + ' KB';
        }

        // ==================== PWA ====================
        function configurarPWA() {
            // Verificar se est√° instalado
            if (window.matchMedia('(display-mode: standalone)').matches) {
                console.log('üì± App rodando como PWA instalado');
            }
            
            // Registrar Service Worker
            if ('serviceWorker' in navigator) {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ Service Worker registrado:', reg.scope))
                    .catch(err => console.log('‚ùå Erro Service Worker:', err));
            }
        }

        // Inicializar automaticamente ap√≥s carregar
        window.onload = function() {
            setTimeout(() => {
                atualizarListaExames();
                atualizarListaCorridas();
            }, 500);
        };
    </script>
</body>
</html>
